name: Regenerate Generated Code

on:
  push:
    branches:
      - main
    paths:
      # Trigger on source model changes
      - 'schema.sql'
      - 'openapi/spec.yaml'
      - 'sqlc/queries/**/*.sql'
      - 'scripts/generate-erd-overview.py'
      # Also trigger on workflow changes
      - '.github/workflows/regenerate-code.yml'
  pull_request:
    paths:
      - 'schema.sql'
      - 'openapi/spec.yaml'
      - 'sqlc/queries/**/*.sql'
      - 'scripts/generate-erd-overview.py'

jobs:
  regenerate:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: ubik
          POSTGRES_PASSWORD: ubik_dev_password
          POSTGRES_DB: ubik
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Install Go tools
        run: |
          go install github.com/sqlc-dev/sqlc/cmd/sqlc@latest
          go install github.com/oapi-codegen/oapi-codegen/v2/cmd/oapi-codegen@latest
          go install go.uber.org/mock/mockgen@latest
          go install github.com/k1LoW/tbls@latest

      - name: Apply database schema
        env:
          PGPASSWORD: ubik_dev_password
        run: |
          psql -h localhost -U ubik -d ubik -f schema.sql

      - name: Run code generation
        env:
          DATABASE_URL: postgres://ubik:ubik_dev_password@localhost:5432/ubik?sslmode=disable
        run: |
          make generate

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet generated/ docs/; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No generated code changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Generated code has changes"
            git diff --stat generated/ docs/
          fi

      - name: Commit and push if changed
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add generated/ docs/
          git commit -m "chore: regenerate code from source models [skip ci]

          Auto-generated by regenerate-code.yml workflow.

          Changes to:
          - Database schema (schema.sql)
          - OpenAPI spec (openapi/spec.yaml)
          - SQL queries (sqlc/queries/)

          Generated:
          - API types and server (generated/api/)
          - Database queries (generated/db/)
          - ERD documentation (docs/)
          - Mock interfaces (generated/mocks/)"
          git push

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request' && steps.changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.name,
              body: 'ðŸ¤– **Generated code has been updated automatically**\n\nChanges to source models triggered code regeneration:\n- API types from OpenAPI spec\n- Database queries from sqlc\n- ERD documentation\n- Mock interfaces\n\nPlease review the generated code changes.'
            })
