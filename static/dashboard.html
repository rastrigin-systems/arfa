<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Ubik Enterprise</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/alpinejs@3.13.0/dist/cdn.min.js" defer></script>
    <style>[x-cloak] { display: none !important; }</style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center space-x-8">
                    <span class="text-xl font-bold text-blue-600">Ubik Enterprise</span>
                    <span id="org-name" class="text-gray-600">[Loading...]</span>
                </div>
                <div class="flex items-center space-x-4" x-data="{ open: false }">
                    <span id="user-email" class="text-gray-700">Loading...</span>
                    <button @click="open = !open" class="text-gray-600 hover:text-gray-900">▼</button>
                    <div x-show="open" @click.away="open = false" x-cloak
                         class="absolute right-4 top-14 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50 border">
                        <a href="/profile.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">My Profile</a>
                        <a href="#" onclick="logout()" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Logout</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Navigation Tabs -->
    <div class="bg-white border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <nav class="flex space-x-8 h-12">
                <a href="/dashboard.html" class="border-b-2 border-blue-500 text-blue-600 px-1 py-3 text-sm font-medium">Dashboard</a>
                <a href="/employees.html" class="border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 px-1 py-3 text-sm font-medium">Employees</a>
                <a href="/teams.html" class="border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 px-1 py-3 text-sm font-medium">Teams</a>
                <a href="/agents.html" class="border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 px-1 py-3 text-sm font-medium">Agents</a>
                <a href="/settings.html" class="border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 px-1 py-3 text-sm font-medium">Settings</a>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8" x-data="dashboard()">
        <h1 class="text-3xl font-bold text-gray-900 mb-6">Welcome back, <span x-text="userName">User</span>!</h1>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Employees Card -->
            <div class="bg-white rounded-lg shadow p-6 border border-gray-200">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-medium text-gray-500">Employees</h3>
                    <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                </div>
                <div class="text-3xl font-bold text-gray-900" x-text="stats.employees.active">-</div>
                <div class="text-sm text-gray-600 mt-1">Active</div>
                <div class="text-sm text-orange-600 mt-2" x-show="stats.employees.pending > 0">
                    <span x-text="stats.employees.pending">0</span> Pending Approvals
                </div>
                <a href="/employees.html" class="text-sm text-blue-600 hover:text-blue-800 mt-2 inline-block">View All →</a>
            </div>

            <!-- Teams Card -->
            <div class="bg-white rounded-lg shadow p-6 border border-gray-200">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-medium text-gray-500">Teams</h3>
                    <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                    </svg>
                </div>
                <div class="text-3xl font-bold text-gray-900" x-text="stats.teams.total">-</div>
                <div class="text-sm text-gray-600 mt-1">Teams</div>
                <div class="text-sm text-gray-600 mt-2">
                    <span x-text="stats.teams.agentsConfigured">0</span> Agents Configured
                </div>
                <a href="/teams.html" class="text-sm text-blue-600 hover:text-blue-800 mt-2 inline-block">Manage →</a>
            </div>

            <!-- Agent Usage Card -->
            <div class="bg-white rounded-lg shadow p-6 border border-gray-200">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-medium text-gray-500">Agent Usage</h3>
                    <svg class="w-8 h-8 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path>
                    </svg>
                </div>
                <div class="space-y-1">
                    <template x-for="agent in stats.agentUsage" :key="agent.name">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-700" x-text="agent.name">-</span>
                            <span class="text-gray-500"><span x-text="agent.users">0</span> users</span>
                        </div>
                    </template>
                </div>
                <a href="/agents.html" class="text-sm text-blue-600 hover:text-blue-800 mt-2 inline-block">Details →</a>
            </div>

            <!-- Budget Card -->
            <div class="bg-white rounded-lg shadow p-6 border border-gray-200">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-medium text-gray-500">This Month</h3>
                    <svg class="w-8 h-8 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div class="text-sm text-gray-600">Budget:</div>
                <div class="text-2xl font-bold text-gray-900">
                    $<span x-text="stats.budget.spent">0</span> / $<span x-text="stats.budget.total">0</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                    <div class="bg-blue-600 h-2 rounded-full" :style="`width: ${stats.budget.percentage}%`"></div>
                </div>
                <div class="text-sm text-gray-600 mt-2">
                    <div>API Calls: <span x-text="stats.usage.apiCalls.toLocaleString()">0</span></div>
                    <div>Tokens: <span x-text="stats.usage.tokens">0</span>M</div>
                </div>
                <a href="#" class="text-sm text-blue-600 hover:text-blue-800 mt-2 inline-block">View Reports →</a>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="bg-white rounded-lg shadow border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">Recent Activity</h2>
            </div>
            <div class="divide-y divide-gray-200">
                <template x-for="activity in recentActivity" :key="activity.id">
                    <div class="px-6 py-4 hover:bg-gray-50">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="flex-shrink-0 w-2 h-2 bg-blue-500 rounded-full"></div>
                                <div>
                                    <span class="text-sm text-gray-900" x-text="activity.message"></span>
                                    <span class="text-xs text-gray-500 ml-2" x-text="activity.time"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
                <div x-show="recentActivity.length === 0" class="px-6 py-8 text-center text-gray-500">
                    No recent activity
                </div>
            </div>
            <div class="px-6 py-4 border-t border-gray-200">
                <a href="#" class="text-sm text-blue-600 hover:text-blue-800">View All Activity →</a>
            </div>
        </div>
    </main>

    <script>
        const API_BASE = '/api/v1';

        function getToken() {
            return localStorage.getItem('auth_token');
        }

        function logout() {
            fetch(`${API_BASE}/auth/logout`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${getToken()}` }
            }).finally(() => {
                localStorage.removeItem('auth_token');
                window.location.href = '/login.html';
            });
        }

        async function loadCurrentUser() {
            const token = getToken();
            if (!token) {
                window.location.href = '/login.html';
                return null;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Unauthorized');

                const employee = await response.json();
                document.getElementById('user-email').textContent = employee.email;

                // Load organization
                const orgResponse = await fetch(`${API_BASE}/organizations/current`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (orgResponse.ok) {
                    const org = await orgResponse.json();
                    document.getElementById('org-name').textContent = `[${org.name}]`;
                }

                return employee;
            } catch (error) {
                console.error('Failed to load user:', error);
                window.location.href = '/login.html';
                return null;
            }
        }

        function dashboard() {
            return {
                userName: '',
                stats: {
                    employees: { active: 0, pending: 0 },
                    teams: { total: 0, agentsConfigured: 0 },
                    agentUsage: [],
                    budget: { spent: 0, total: 0, percentage: 0 },
                    usage: { apiCalls: 0, tokens: 0 }
                },
                recentActivity: [],

                async init() {
                    const employee = await loadCurrentUser();
                    if (employee) {
                        this.userName = employee.full_name.split(' ')[0];
                        await this.loadStats();
                    }
                },

                async loadStats() {
                    const token = getToken();
                    const headers = { 'Authorization': `Bearer ${token}` };

                    try {
                        // Load employees
                        const employeesRes = await fetch(`${API_BASE}/employees`, { headers });
                        if (employeesRes.ok) {
                            const data = await employeesRes.json();
                            this.stats.employees.active = data.total;
                        }

                        // Load pending requests count
                        const pendingRes = await fetch(`${API_BASE}/agent-requests/pending/count`, { headers });
                        if (pendingRes.ok) {
                            const data = await pendingRes.json();
                            this.stats.employees.pending = data.pending_count;
                        }

                        // Load teams
                        const teamsRes = await fetch(`${API_BASE}/teams`, { headers });
                        if (teamsRes.ok) {
                            const data = await teamsRes.json();
                            this.stats.teams.total = data.total;
                            this.stats.teams.agentsConfigured = 8; // TODO: Calculate from API
                        }

                        // Load agent configs (mock for now)
                        const agentsRes = await fetch(`${API_BASE}/agents`, { headers });
                        if (agentsRes.ok) {
                            const data = await agentsRes.json();
                            // Mock usage data
                            this.stats.agentUsage = data.agents.slice(0, 3).map(agent => ({
                                name: agent.name,
                                users: Math.floor(Math.random() * 50) + 10
                            }));
                        }

                        // Load subscription/budget data from API
                        const subscriptionRes = await fetch(`${API_BASE}/organizations/current/subscription`, { headers });
                        if (subscriptionRes.ok) {
                            const data = await subscriptionRes.json();
                            this.stats.budget = {
                                spent: data.current_spending_usd,
                                total: data.monthly_budget_usd,
                                percentage: Math.round(data.spending_percentage)
                            };
                        }

                        // Load organization usage stats from API
                        const usageRes = await fetch(`${API_BASE}/usage-stats/org`, { headers });
                        if (usageRes.ok) {
                            const data = await usageRes.json();
                            this.stats.usage = {
                                apiCalls: data.total_api_calls || 0,
                                tokens: ((data.total_tokens || 0) / 1000000).toFixed(1) // Convert to millions
                            };
                        }

                        // Load activity logs from API
                        const activityRes = await fetch(`${API_BASE}/activity-logs?limit=10`, { headers });
                        if (activityRes.ok) {
                            const data = await activityRes.json();
                            this.recentActivity = data.activity_logs.map(log => ({
                                id: log.id,
                                message: log.employee_name ? `${log.employee_name} ${log.message}` : log.message,
                                time: log.time
                            }));
                        }

                    } catch (error) {
                        console.error('Failed to load stats:', error);
                    }
                }
            }
        }
    </script>
</body>
</html>
