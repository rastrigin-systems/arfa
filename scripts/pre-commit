#!/bin/bash
#
# Pre-commit hook for Ubik Enterprise
# Automatically regenerates ERD documentation when schema changes
#
# Source models:
#   - schema.sql (database schema)
#   - openapi/spec.yaml (API specification)
#   - sqlc/queries/*.sql (SQL queries)
#   - scripts/generate-erd-overview.py (ERD generator)
#
# Generated outputs (committed to git):
#   - docs/ERD.md (user-friendly ERD)
#   - docs/README.md (technical reference)
#   - docs/schema.json (machine-readable schema)
#   - docs/schema.svg (visual diagram)
#   - docs/public.*.md (per-table docs)
#
# Note: generated/ (Go code) is NOT committed - run 'make generate' locally
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}ðŸ” Checking for source model changes...${NC}"

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only)

# Check if any source models changed
SOURCE_MODELS_CHANGED=false

if echo "$STAGED_FILES" | grep -qE "^schema\.sql$|^openapi/spec\.yaml$|^sqlc/queries/.*\.sql$|^scripts/generate-erd-overview\.py$"; then
    SOURCE_MODELS_CHANGED=true
fi

if [ "$SOURCE_MODELS_CHANGED" = false ]; then
    echo -e "${GREEN}âœ“ No source model changes detected, skipping code generation${NC}"
    exit 0
fi

echo -e "${YELLOW}ðŸ“ Source models changed, regenerating code...${NC}"

# Check if required tools are installed (only tbls for ERD generation)
if ! command -v tbls &> /dev/null; then
    echo -e "${RED}âŒ Missing required tool: tbls${NC}"
    echo -e "${YELLOW}Run: make install-tools${NC}"
    exit 1
fi

# Check if Python is available (for ERD overview generation)
if ! command -v python3 &> /dev/null; then
    echo -e "${RED}âŒ Missing required tool: python3${NC}"
    exit 1
fi

# Check if database is running (for ERD generation)
if ! docker ps | grep -q ubik-postgres; then
    echo -e "${YELLOW}âš ï¸  PostgreSQL not running. Starting database...${NC}"
    make db-up
    sleep 3
fi

# Run ERD generation only
echo -e "${BLUE}ðŸ”§ Running: make generate-erd${NC}"
if ! make generate-erd; then
    echo -e "${RED}âŒ ERD generation failed${NC}"
    echo -e "${YELLOW}Fix the errors and try again${NC}"
    exit 1
fi

# Check if docs changed
DOCS_CHANGES=$(git diff --name-only docs/ 2>/dev/null || echo "")

if [ -z "$DOCS_CHANGES" ]; then
    echo -e "${GREEN}âœ“ Documentation is already up to date${NC}"
    exit 0
fi

# Add docs to staging
echo -e "${BLUE}ðŸ“¦ Adding documentation to commit...${NC}"
git add docs/

echo -e "${GREEN}âœ“ ERD regeneration complete!${NC}"
echo -e "${BLUE}Documentation files added to commit:${NC}"
echo "$DOCS_CHANGES" | sed 's/^/  - /'

exit 0
